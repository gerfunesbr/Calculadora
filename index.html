<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora de Aduba√ß√£o - Piment√£o</title>

  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#2e7d32">
  <meta name="description" content="Calculadora profissional para aduba√ß√£o de piment√£o">
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" type="image/png" href="./icons/icon-72x72.png">
  <link rel="apple-touch-icon" href="./icons/icon-192x192.png">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #2e7d32;
      --primary-light: #4caf50;
      --text: #333;
      --light-gray: #f5f5f5;
      --border: #ddd;
      --white: #fff;
      --background: #f5f5f5;
      --card-bg: #fff;
      --footer-bg: transparent;
    }

    /* Modo Noturno */
    [data-theme="dark"] {
      --primary: #4caf50;
      --primary-light: #66bb6a;
      --text: #e0e0e0;
      --light-gray: #121212;
      --border: #444;
      --white: #1e1e1e;
      --background: #121212;
      --card-bg: #1e1e1e;
      --footer-bg: #1a1a1a;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      line-height: 1.5;
      color: var(--text);
      background-color: var(--background);
      padding: 16px;
      max-width: 1200px;
      margin: 0 auto;
      padding-bottom: 80px; /* Espa√ßo para a barra inferior */
      transition: all 0.3s ease;
    }

    header {
      text-align: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
      position: relative;
    }

    h1 {
      font-size: 1.5rem;
      color: var(--primary);
      margin-bottom: 4px;
    }

    .subtitle {
      color: var(--text);
      opacity: 0.8;
      font-size: 0.9rem;
    }

    .theme-toggle {
      position: absolute;
      top: 0;
      right: 0;
      background: var(--primary);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.3s ease;
    }

    .theme-toggle:hover {
      background: var(--primary-light);
    }

    .main-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .control-panel {
      background: var(--card-bg);
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }

    select {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 1rem;
      margin-bottom: 12px;
      background: var(--card-bg);
      color: var(--text);
      transition: all 0.3s ease;
    }

    .etapa-info {
      font-size: 0.85rem;
      color: var(--text);
      opacity: 0.8;
      padding: 8px;
      background-color: var(--light-gray);
      border-radius: 4px;
      transition: all 0.3s ease;
    }

    .results-container {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow: hidden;
      transition: all 0.3s ease;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    th {
      background-color: var(--primary);
      color: white;
      padding: 10px 8px;
      text-align: left;
      font-weight: 500;
    }

    td {
      padding: 8px;
      border-bottom: 1px solid var(--border);
      transition: all 0.3s ease;
    }

    tr:nth-child(even) {
      background-color: var(--light-gray);
    }

    .total-results {
      background-color: var(--primary-light);
      color: white;
      padding: 12px;
      text-align: center;
      font-weight: 500;
    }

    .formula-section {
      padding: 16px;
      border-top: 1px solid var(--border);
      transition: all 0.3s ease;
    }

    .formula-section h3 {
      font-size: 1rem;
      margin-bottom: 10px;
      color: var(--primary);
    }

    .formula {
      font-family: 'Courier New', monospace;
      font-size: 0.8rem;
      margin-bottom: 6px;
      padding: 4px 0;
      color: var(--text);
      transition: all 0.3s ease;
    }

    .chart-container {
      padding: 16px;
      border-top: 1px solid var(--border);
      height: 300px;
      transition: all 0.3s ease;
    }

    .chart-container h3 {
      font-size: 1rem;
      margin-bottom: 12px;
      color: var(--primary);
    }

    #chart {
      width: 100% !important;
      height: 250px !important;
    }

    footer {
      text-align: center;
      margin-top: 24px;
      padding: 16px;
      border-top: 1px solid var(--border);
      color: var(--text);
      font-size: 0.8rem;
      background-color: var(--footer-bg);
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .install-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 4px;
      margin-top: 10px;
      cursor: pointer;
      display: none;
      transition: all 0.3s ease;
    }

    .install-btn:hover {
      background: var(--primary-light);
    }

    /* Estilo da Barra Inferior */
    .bottom-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: var(--card-bg);
      border-top: 1px solid var(--border);
      padding: 10px;
      display: flex;
      justify-content: center;
      gap: 20px;
      box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      transition: all 0.3s ease;
    }

    .bottom-bar button {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }

    .bottom-bar button:hover {
      background-color: var(--primary-light);
      transform: translateY(-2px);
    }

    .bottom-bar button:active {
      transform: translateY(0);
    }

    @media (min-width: 768px) {
      .main-container {
        flex-direction: row;
      }

      .control-panel {
        flex: 1;
        max-width: 300px;
      }

      .results-container {
        flex: 2;
      }

      h1 {
        font-size: 1.75rem;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 12px;
      }

      th, td {
        padding: 6px 4px;
      }

      table {
        font-size: 0.75rem;
      }

      .theme-toggle {
        position: relative;
        margin-top: 10px;
      }

      .bottom-bar {
        padding: 8px;
        gap: 10px;
      }

      .bottom-bar button {
        padding: 8px 16px;
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Calculadora de Aduba√ß√£o para Piment√£o</h1>
    <p class="subtitle">C√°lculo preciso para diferentes etapas do cultivo</p>
    <button id="installBtn" class="install-btn">Instalar App</button>
    <button id="themeToggle" class="theme-toggle">
      <span id="themeIcon">üåô</span>
      <span id="themeText">Modo Escuro</span>
    </button>
  </header>

  <div class="main-container">
    <div class="control-panel">
      <label for="etapaSelect">Etapa de Aduba√ß√£o:</label>
      <select id="etapaSelect" onchange="updateCalculations()">
        <option value="Primeiro">Primeiro - Aduba√ß√£o Inicial</option>
        <option value="Segundo">Segundo - Fertiliza√ß√£o</option>
        <option value="Terceiro">Terceiro - Aplica√ß√£o de Nitrato</option>
        <option value="Quarto">Quarto - Suplementa√ß√£o de Magn√©sio</option>
        <option value="Quinto">Quinto - Refor√ßo de Nitrato</option>
        <option value="Sexto">Sexto - Estimulante de Crescimento</option>
      </select>

      <div class="etapa-info" id="etapaInfo">
        Selecione uma etapa para ver informa√ß√µes.
      </div>
    </div>

    <div class="results-container">
      <table id="lotesTable">
        <thead>
          <tr>
            <th>Setor</th>
            <th>Mudas</th>
            <th>Adubo</th>
            <th>Por Muda</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          <!-- Tabela ser√° preenchida dinamicamente -->
        </tbody>
      </table>

      <div class="total-results" id="totalResult">
        <!-- Resultados totais ser√£o exibidos aqui -->
      </div>

      <div class="formula-section" id="formulaSection">
        <h3>F√≥rmulas de C√°lculo</h3>
        <!-- F√≥rmulas ser√£o exibidas aqui -->
      </div>

      <div class="chart-container">
        <h3>Distribui√ß√£o por Setor</h3>
        <canvas id="chart"></canvas>
      </div>
    </div>
  </div>

  <footer>
    <p>Calculadora de Aduba√ß√£o para Piment√£o &copy; 2023</p>
  </footer>

  <!-- Barra Inferior -->
  <div class="bottom-bar">
    <button onclick="window.location.href='https://gerfunesbr.github.io/Calculadora/molha.html'">Molhar</button>
  </div>

<script>
    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/Calculadora/sw.js')
          .then((registration) => {
            console.log('Service Worker registrado com sucesso:', registration);
            
            // Verifica se h√° uma nova vers√£o do Service Worker
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              console.log('Nova vers√£o do Service Worker encontrada!');
              
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  console.log('Nova vers√£o pronta! Recarregue para atualizar.');
                  // Aqui voc√™ pode mostrar um bot√£o para o usu√°rio atualizar
                }
              });
            });
          })
          .catch((error) => {
            console.log('Falha ao registrar Service Worker:', error);
          });

        // Ouvinte para quando o Service Worker estiver pronto
        navigator.serviceWorker.ready.then(() => {
          console.log('Aplica√ß√£o pronta para funcionar offline!');
        });
      });

      // Ouvinte para recarregar quando novo Service Worker assumir controle
      let refreshing = false;
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (!refreshing) {
          refreshing = true;
          console.log('Novo Service Worker ativo! Recarregando...');
          window.location.reload();
        }
      });
    }

    // PWA Install Prompt
    let deferredPrompt;
    const installBtn = document.getElementById('installBtn');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'block';
    });

    installBtn.addEventListener('click', () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            console.log('Usu√°rio aceitou a instala√ß√£o');
            installBtn.style.display = 'none';
          }
          deferredPrompt = null;
        });
      }
    });

    // Sistema de Tema
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const themeText = document.getElementById('themeText');

    // Verificar prefer√™ncia salva ou do sistema
    function loadTheme() {
      const savedTheme = localStorage.getItem('theme') || 
                        (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');

      document.documentElement.setAttribute('data-theme', savedTheme);
      updateThemeButton(savedTheme);
    }

    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeButton(newTheme);

      // Atualizar gr√°fico para o novo tema
      if (chartInstance) {
        updateChart(document.getElementById('etapaSelect').value);
      }
    }

    function updateThemeButton(theme) {
      if (theme === 'dark') {
        themeIcon.textContent = '‚òÄÔ∏è';
        themeText.textContent = 'Modo Claro';
      } else {
        themeIcon.textContent = 'üåô';
        themeText.textContent = 'Modo Escuro';
      }
    }

    themeToggle.addEventListener('click', toggleTheme);

    // App Data and Logic
    const setores = {
      'Setor 5': 1964,
      'Setor 4': 2675,
      'Setor 3': 3150,
      'Setor 2': 3812,
      'Setor 1': 3811
    };

    // DADOS ATUALIZADOS CONFORME SOLICITADO
    const adubacaoEtapas = {
      'Primeiro': [
        { 
          tipo: 'MAP', 
          peso: 1.0, 
          unidade: 'g',
          descricao: 'Fosfato monoam√¥nico - fornece f√≥sforo e nitrog√™nio para o desenvolvimento inicial'
        }
      ],
      'Segundo': [
        { 
          tipo: 'Krista K', 
          peso: 0.9, 
          unidade: 'g',
          descricao: 'Fonte de pot√°ssio sol√∫vel - essencial para o desenvolvimento vegetativo'
        }
      ],
      'Terceiro': [
        { 
          tipo: 'Calcinit', 
          peso: 4, 
          unidade: 'g',
          descricao: 'Nitrato de c√°lcio - fornece c√°lcio e nitrog√™nio n√≠trico para crescimento'
        }
      ],
      'Quarto': [
        { 
          tipo: 'Sulfato de Magn√©sio', 
          peso: 3, 
          unidade: 'g',
          descricao: 'Fonte de magn√©sio e enxofre - importante para a fotoss√≠ntese'
        }
      ],
      'Quinto': [
        { 
          tipo: 'Calcinit', 
          peso: 4, 
          unidade: 'g',
          descricao: 'Refor√ßo de nitrato de c√°lcio - mant√©m o crescimento equilibrado'
        }
      ],
      'Sexto': [
        { 
          tipo: 'Krista K', 
          peso: 0.9, 
          unidade: 'g',
          descricao: 'Pot√°ssio final - importante para a qualidade dos frutos'
        }
      ]
    };

    const etapaDescricoes = {
      'Primeiro': 'Aduba√ß√£o inicial com MAP - 1g por muda para prepara√ß√£o do solo e desenvolvimento radicular.',
      'Segundo': 'Fertiliza√ß√£o com Krista K - 0.9g por muda para estimular o crescimento vegetativo.',
      'Terceiro': 'Aplica√ß√£o de Calcinit - 4g por muda para fortalecer o desenvolvimento foliar.',
      'Quarto': 'Suplementa√ß√£o de Sulfato de Magn√©sio - 3g por muda para melhorar a fotoss√≠ntese.',
      'Quinto': 'Refor√ßo de Calcinit - 4g por muda para manter o crescimento equilibrado.',
      'Sexto': 'Aplica√ß√£o final de Krista K - 0.9g por muda para melhorar a qualidade dos frutos.'
    };

    const table = document.getElementById('lotesTable').getElementsByTagName('tbody')[0];
    const totalResult = document.getElementById('totalResult');
    const formulaSection = document.getElementById('formulaSection');
    const etapaInfo = document.getElementById('etapaInfo');
    let chartInstance;

    // Fun√ß√£o para calcular quantidade por muda
    function calcularQuantidadePorMuda(adubo) {
      return adubo.peso;
    }

    // Fun√ß√£o para calcular quantidade total
    function calcularQuantidadeTotal(adubo, mudas) {
      const quantidadePorMuda = calcularQuantidadePorMuda(adubo);
      return mudas * quantidadePorMuda;
    }

    function updateCalculations() {
      const etapaSelecionada = document.getElementById('etapaSelect').value;
      const adubos = adubacaoEtapas[etapaSelecionada];

      // Atualizar informa√ß√µes da etapa
      etapaInfo.textContent = etapaDescricoes[etapaSelecionada];

      // Limpar tabela
      table.innerHTML = '';
      formulaSection.innerHTML = '<h3>F√≥rmulas de C√°lculo</h3>';

      let totalMudas = 0;
      let totalPeso = 0;

      // Calcular para cada setor
      for (const [setor, mudas] of Object.entries(setores)) {
        totalMudas += mudas;

        adubos.forEach(adubo => {
          const quantidadePorMuda = calcularQuantidadePorMuda(adubo);
          const quantidadeTotal = calcularQuantidadeTotal(adubo, mudas);

          totalPeso += quantidadeTotal;

          // Adicionar linha na tabela
          const row = table.insertRow();
          row.insertCell(0).innerText = setor;
          row.insertCell(1).innerText = mudas.toLocaleString('pt-BR');
          row.insertCell(2).innerText = adubo.tipo;
          row.insertCell(3).innerText = `${quantidadePorMuda.toFixed(1)} ${adubo.unidade}`;
          row.insertCell(4).innerText = `${quantidadeTotal.toFixed(2)} ${adubo.unidade}`;

          // Adicionar f√≥rmula
          const formulaText = `${setor}: ${mudas.toLocaleString('pt-BR')} mudas √ó ${quantidadePorMuda.toFixed(1)} ${adubo.unidade}/muda = ${quantidadeTotal.toFixed(2)} ${adubo.unidade}`;

          const formulaDiv = document.createElement('div');
          formulaDiv.className = 'formula';
          formulaDiv.innerText = formulaText;
          formulaSection.appendChild(formulaDiv);
        });
      }

      // Atualizar resultados totais
      let resultadoTexto = `Total de Mudas: ${totalMudas.toLocaleString('pt-BR')}`;
      if (totalPeso > 0) {
        resultadoTexto += ` | Peso Total: ${totalPeso.toFixed(2)}g`;
      }
      totalResult.innerText = resultadoTexto;

      // Atualizar gr√°fico
      updateChart(etapaSelecionada);
    }

    function updateChart(etapaSelecionada) {
      const adubos = adubacaoEtapas[etapaSelecionada];
      const ctx = document.getElementById('chart').getContext('2d');

      if (chartInstance) {
        chartInstance.destroy();
      }

      // Preparar dados para o gr√°fico
      const labels = Object.keys(setores);
      const datasets = [];

      // Para cada tipo de adubo, criar um dataset
      adubos.forEach((adubo, index) => {
        const cores = ['#4caf50', '#ff9800', '#2196f3', '#9c27b0', '#f44336'];
        const data = Object.values(setores).map(mudas => {
          return calcularQuantidadeTotal(adubo, mudas);
        });

        datasets.push({
          label: `${adubo.tipo} (${adubo.unidade})`,
          data: data,
          backgroundColor: cores[index % cores.length],
          borderColor: cores[index % cores.length],
          borderWidth: 1
        });
      });

      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: getComputedStyle(document.documentElement).getPropertyValue('--text')
              },
              grid: {
                color: getComputedStyle(document.documentElement).getPropertyValue('--border')
              }
            },
            x: {
              ticks: {
                color: getComputedStyle(document.documentElement).getPropertyValue('--text')
              },
              grid: {
                color: getComputedStyle(document.documentElement).getPropertyValue('--border')
              }
            }
          },
          plugins: {
            legend: {
              position: 'top',
              labels: {
                color: getComputedStyle(document.documentElement).getPropertyValue('--text')
              }
            },
            title: {
              display: true,
              text: `Distribui√ß√£o - ${etapaSelecionada}`,
              color: getComputedStyle(document.documentElement).getPropertyValue('--text')
            }
          }
        }
      });
    }

    // Inicializar ao carregar
    document.addEventListener('DOMContentLoaded', function() {
      loadTheme();
      updateCalculations();
      
      // Verificar se est√° online/offline
      window.addEventListener('online', () => {
        console.log('Aplica√ß√£o online');
      });
      
      window.addEventListener('offline', () => {
        console.log('Aplica√ß√£o offline - funcionando com cache');
      });
    });
  </script>
</body>
</html>